"use client";

import { useAtom, useAtomValue } from "jotai";
import { useParams } from "next/navigation";

import { useGetInternalRegistryImageTagVulnerabilities } from "@/domain/internal-registry-image/hooks/use-get-internal-registry-image-tag-vulnerabilities";
import {
  adminInternalRegistryImageTagSelectedItemAtom,
  adminInternalRegistryImageTagVulnerabilityPageAtom,
} from "@/domain/internal-registry-image/state/internal-registry-image.atom";
import { createVulnerabilityColumn } from "@/shared/components/column/create-vulnerability-column";
import { CustomizedTable } from "@/shared/components/table/customized-table";
import { LIST_PAGE_SIZE } from "@/shared/constants/core.constant";
import { ListWrapper } from "@/styles/layers/list-page-layers.styled";

export function AdminInternalRegistryImageTagVulnerabilityListBody() {
  const { id } = useParams();
  const [page, setPage] = useAtom(
    adminInternalRegistryImageTagVulnerabilityPageAtom,
  );
  const setSelectedItem = useAtomValue(
    adminInternalRegistryImageTagSelectedItemAtom,
  );

  const { data } = useGetInternalRegistryImageTagVulnerabilities({
    page,
    size: LIST_PAGE_SIZE,
    tagId: Number(setSelectedItem),
    imageId: Number(id),
  });

  return (
    <ListWrapper>
      <CustomizedTable
        columns={createVulnerabilityColumn([
          { dataIndex: "cve" },
          { dataIndex: "severity" },
          { dataIndex: "nvd" },
          { dataIndex: "redhat" },
          { dataIndex: "package" },
          { dataIndex: "version" },
        ])}
        activePadding
        data={data?.content || []}
        pagination={{
          onChange: (nextPage: number) => {
            setPage(nextPage);
          },
          pageSize: LIST_PAGE_SIZE,
          total: data?.totalSize,
        }}
      />
    </ListWrapper>
  );
}

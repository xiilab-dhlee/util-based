"use client";

import { useState } from "react";
import { Icon, InfoModal } from "xiilab-ui";

import { openViewVulnerabilityModalAtom } from "@/atoms/common/modal.atom";
import { createVulnerabilityColumn } from "@/components/common/columns/create-vulnerability-column";
import { COMMON_EVENTS } from "@/constants/common/pubsub.constant";
import { useGlobalModal } from "@/hooks/common/use-global-modal";
import { useSubscribe } from "@/hooks/common/use-pub-sub";
import type { VulnerabilityListType } from "@/schemas/vulnerability.schema";
import { CustomizedTable } from "../table/customized-table";

/**
 * ViewVulnerabilityModal 컴포넌트
 *
 * 볼륨 파일의 취약점 정보를 테이블 형태로 표시하는 모달 컴포넌트입니다.
 * 취약점 목록을 페이지네이션과 함께 제공하며, 보안 분석 결과를
 * 사용자가 쉽게 확인할 수 있도록 구성되어 있습니다.
 *
 */
export function ViewVulnerabilityModal() {
  const { open, onOpen, onClose } = useGlobalModal(
    openViewVulnerabilityModalAtom,
  );

  const [vulnerabilities, setVulnerabilities] = useState<
    VulnerabilityListType[]
  >([]);

  useSubscribe<VulnerabilityListType[]>(
    COMMON_EVENTS.sendVulnerability,
    (data) => {
      setVulnerabilities(data);
      onOpen();
    },
  );

  return (
    <InfoModal
      type="primary"
      modalWidth={800}
      icon={<Icon name="Folder" color="#fff" size={18} />}
      open={open}
      closable
      onClose={onClose}
      title="볼륨 파일 취약점"
      centered
    >
      {/* 취약점 정보 테이블 */}
      <CustomizedTable
        columns={createVulnerabilityColumn()}
        data={vulnerabilities}
        pagination={{
          onChange: function Xs() {}, // 페이지 변경 핸들러 (현재 미구현)
          pageSize: 5, // 한 페이지당 표시할 항목 수
          total: vulnerabilities.length, // 전체 데이터 개수
        }}
        showTotal={false} // 총 개수 표시 비활성화
      />
    </InfoModal>
  );
}

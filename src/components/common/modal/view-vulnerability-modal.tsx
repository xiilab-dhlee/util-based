"use client";

import { useState } from "react";
import { Icon, InfoModal, Table } from "xiilab-ui";
import { COMMON_EVENTS } from "@/constants/common/pubsub.constant";

import { openViewVulnerabilityModalAtom } from "@/atoms/common/modal.atom";
import { createVulnerabilityColumn } from "@/components/common/columns/create-vulnerability-column";
import { COMMON_EVENTS } from "@/constants/common/pubsub.constant";

import { useGlobalModal } from "@/hooks/common/use-global-modal";
import { useSubscribe } from "@/hooks/common/use-pub-sub";
import type { Vulnerability } from "@/types/security/security.model";
import { COMMON_EVENTS } from "@/constants/common/pubsub.constant";

/**
 * ViewVulnerabilityModal 컴포넌트
 *
 * 볼륨 파일의 취약점 정보를 테이블 형태로 표시하는 모달 컴포넌트입니다.
 * 취약점 목록을 페이지네이션과 함께 제공하며, 보안 분석 결과를
 * 사용자가 쉽게 확인할 수 있도록 구성되어 있습니다.
 *
 * 주요 기능:
 * - 볼륨 파일 취약점 목록 테이블 표시
 * - 페이지네이션을 통한 대용량 데이터 처리
 * - 취약점 정보의 체계적 정리 및 표시
 * - 모달 형태로 독립적인 UI 제공
 * - 작은 크기의 테이블로 공간 효율성 확보
 *
 * 데이터 흐름:
 * 1. Pub/Sub 시스템을 통해 취약점 데이터 수신
 * 2. 전역 모달 상태 관리로 모달 열기/닫기 제어
 * 3. 테이블 컴포넌트를 통한 데이터 표시
 *
 * @returns 취약점 조회 모달 JSX 요소
 *
 * @example
 * ```tsx
 * // 모달 열기 (Pub/Sub 이벤트 발행)
 * publish(COMMON_EVENTS.sendVulnerability, vulnerabilityData);
 *
 * // 모달은 자동으로 열리고 데이터가 표시됩니다
 * ```
 */
export function ViewVulnerabilityModal() {
  // 전역 모달 상태 관리 훅
  // openViewVulnerabilityModalAtom을 통해 모달의 열림/닫힘 상태 제어
  const { open, onOpen, onClose } = useGlobalModal(
    openViewVulnerabilityModalAtom,
  );

  // 취약점 데이터 상태 관리
  // Pub/Sub 시스템을 통해 전달받은 취약점 목록을 저장
  const [dataSource, setDataSource] = useState<Vulnerability[]>([]);

  // Pub/Sub 구독 설정
  // 취약점 데이터 전송 이벤트를 구독하여 데이터 소스 업데이트
  useSubscribe<Vulnerability[]>(
    COMMON_EVENTS.sendVulnerability,
    (data) => {
      setDataSource(data);
      onOpen();
    },
  );

  return (
    <InfoModal
      type="primary"
      modalWidth={800}
      icon={<Icon name="Folder" color="#fff" size={18} />}
      open={open}
      closable
      onClose={onClose}
      title="볼륨 파일 취약점"
      centered
    >
      {/* 취약점 정보 테이블 */}
      <Table
        columns={createVulnerabilityColumn()}
        dataSource={dataSource}
        pagination={{
          onChange: function Xs() {}, // 페이지 변경 핸들러 (현재 미구현)
          pageSize: 5, // 한 페이지당 표시할 항목 수
          total: dataSource.length, // 전체 데이터 개수
        }}
        showTotal={false} // 총 개수 표시 비활성화
        size="small" // 작은 크기의 테이블로 공간 효율성 확보
        style={{
          minHeight: "208px", // 최소 높이 설정으로 일관된 UI 제공
        }}
      />
    </InfoModal>
  );
}

